<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.training.modules.sys.dao.BeautyDao">
    
    <sql id="selectApptOrder">
    	SELECT
			COUNT(mao.id) AS appt_count,
			mao.beautician_id
		FROM
			mtmydb.mtmy_appt_order mao
		WHERE
			mao.appt_status IN (1, 2)
			AND id > #{apptOrderId}
		GROUP BY
			mao.beautician_id
    </sql>
    <sql id="selectBeautyComment">
    	SELECT
			beauty_id,
			COUNT(content) AS evaluation_count,
			FORMAT((SUM((IFNULL(service_rank,0) + IFNULL(beauty_rank,0) + IFNULL(skill_rank,0))/3) / COUNT(content)),1) AS evaluation_score
		FROM
			mtmydb.mtmy_beauty_comment
		WHERE
			comm_id > #{commId}
		GROUP BY
			beauty_id
    </sql>
    
    <!-- 获取定时器截止的  预约id -->
    <select id="findApptOrderId" resultType="int">
    	SELECT
			id
		FROM
			mtmydb.mtmy_appt_order
		ORDER BY
			id DESC
		LIMIT 1
    </select>
    
    <!-- 获取定时器截止的  评论id -->
    <select id="findCommId" resultType="int">
    	SELECT
			comm_id
		FROM
			mtmydb.mtmy_beauty_comment
		ORDER BY
			comm_id DESC
		LIMIT 1
    </select>
    
    <!-- 查询技师的所有统计数据 -->
	<select id="queryBeautyCountData" resultType="BeautyCountData" parameterType="java.util.Map">
		SELECT
			t2.beauty_id AS 'beautyId',
			t1.appt_count AS 'apptCount',
			t2.evaluation_count AS 'evaluationCount',
			t2.evaluation_score AS 'evaluationScore',
			IFNULL((SELECT tbs.beauty_id FROM trains.train_beauty_statistics tbs WHERE tbs.beauty_id = t2.beauty_id),"NULL")AS 'isExist'
		FROM
			(<include refid="selectApptOrder"></include>) t1
		LEFT JOIN (
			<include refid="selectBeautyComment"></include>) t2 ON t2.beauty_id = t1.beautician_id
	</select>
	
	<!-- 修改train_beauty_statistics 表中技师的统计数据 -->
	<update id="updateBeautyCountData" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" separator=";">
	        UPDATE `trains`.`train_beauty_statistics`
	        <set>
	            `evaluation_score` = ((evaluation_score * evaluation_count + #{item.evaluationScore} * #{item.evaluationCount}) / (evaluation_count + #{item.evaluationCount})),
				`evaluation_count` = evaluation_count + #{item.evaluationCount},
		 		`appt_count` = appt_count + #{item.apptCount},
		 		`update_date` = SYSDATE()
	        </set>
	        WHERE
				beauty_id = #{item.beautyId}
    	</foreach>
	</update>
	
	<!-- 将技师的统计数据插入train_beauty_statistics 表 -->
	<insert id="addBeautyCountData" parameterType="java.util.List">
		INSERT INTO `trains`.`train_beauty_statistics` (
			`beauty_id`,
			`is_sham`,
			`evaluation_score`,
			`evaluation_count`,
			`appt_count`,
			`update_date`
		)
		VALUES
		<foreach collection="list" item="item" index="index" separator="," >  
        (
	        #{item.beautyId},
	        '0',
	        #{item.evaluationScore},
	        #{item.evaluationCount},
	        #{item.apptCount},
	        SYSDATE()
	    )
	    </foreach>
	</insert>
</mapper>