<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.training.modules.sys.dao.OfficeDao">

	<sql id="officeColumns">
		a.id,
		a.parent_id AS "parent.id",
		a.parent_ids,
		a.area_id AS "area.id",
		a.code,
		a.name,
		a.sort,
		a.type,
		a.grade,
		a.address, 
		a.zip_code, 
		a.master, 
		a.phone, 
		a.fax, 
		a.email, 
		a.remarks,
		a.create_by AS "createBy.id",
		a.create_date,
		a.update_by AS "updateBy.id",
		a.update_date,
		a.del_flag,
		a.useable AS useable,
		a.primary_person AS "primaryPerson.id",
		a.deputy_person AS "deputyPerson.id",
		p.name AS "parent.name",
		ar.name AS "area.name",
		ar.parent_ids AS "area.parentIds",
		pp.name AS "primaryPerson.name",
		dp.name AS "deputyPerson.name"
	</sql>
	
	<sql id="officeJoins">
		LEFT JOIN sys_office p ON p.id = a.parent_id
		LEFT JOIN sys_area ar ON ar.id = a.area_id
		LEFT JOIN sys_user pp ON pp.id = a.primary_person
		LEFT JOIN sys_user dp ON dp.id = a.deputy_person
    </sql>
	
	<select id="get" resultType="Office">
		SELECT
			<include refid="officeColumns"/>
		FROM sys_office a
		<include refid="officeJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="getByCode" resultType="Office">
		SELECT
			<include refid="officeColumns"/>
		FROM sys_office a
		<include refid="officeJoins"/>
		
		WHERE a.code = #{code}
		AND a.del_flag = 0
	</select>
	
	<!-- 根据roleID找到office对象 -->
	<select id="getRolebyOff" resultType="Office">
		SELECT
			a.id,
			a.parent_id AS "parent.id",
			a.parent_ids,
			a.area_id AS "area.id",
			a.code,
			a.name,
			a.sort,
			a.type,
			a.grade,
			a.address, 
			a.zip_code, 
			a.master, 
			a.phone, 
			a.fax, 
			a.email, 
			a.remarks,
			a.create_by AS "createBy.id",
			a.create_date,
			a.update_by AS "updateBy.id",
			a.update_date,
			a.del_flag,
			a.useable AS useable,
			a.primary_person AS "primaryPerson.id",
			a.deputy_person AS "deputyPerson.id"
		FROM sys_office a , sys_role b
		WHERE a.id = b.office_id
		AND b.id = #{roleid}
	</select>
	
	<select id="findList" resultType="Office">
		
	
		SELECT
			<include refid="officeColumns"/>
			,(SELECT COUNT(*) FROM sys_office AS B WHERE A.id=B.parent_id AND B.del_flag=0) AS 'num'
		FROM sys_office a
		<include refid="officeJoins"/>
		WHERE a.del_flag = #{DEL_FLAG_NORMAL}
		<!-- 数据范围过滤 -->
		${sqlMap.dsf}
		OR a.id = #{currentUser.office.id}
<!-- 		ORDER BY a.code -->
	</select>
			
	<select id="findAllList" resultType="Office">
		SELECT
			<include refid="officeColumns"/>
			,(SELECT COUNT(*) FROM sys_office AS B WHERE A.id=B.parent_id AND B.del_flag=0) AS 'num'
		FROM sys_office a
		<include refid="officeJoins"/>
		WHERE a.del_flag = #{DEL_FLAG_NORMAL}
		ORDER BY a.code
	</select>
	
	<select id="findListbyPID" resultType="Office">
		SELECT
			<include refid="officeColumns"/>
		FROM sys_office a
		<include refid="officeJoins"/>
		WHERE a.del_flag = 0
		and a.parent_id=#{pid}
		ORDER BY a.code
	</select>
	
	<!-- 通过区域加载店铺 -->
	<select id="findListByAreaId" resultType="Office">
		SELECT
			<include refid="officeColumns"/>
		FROM sys_office a
		<include refid="officeJoins"/>
		WHERE a.del_flag = 0
		and a.area_id=#{id}
		and a.grade = 1
		ORDER BY a.code
	</select>
	<!-- 获取当前用户有权限访问的部门 -->
	<select id="findByParentIdsLikeAuth" resultType="Office">
		SELECT
			a.id,
			a.parent_id AS 'parent.id',
			a.parent_ids,
			a.CODE,
			a.NAME,
			a.type,
			a.grade,
			a.remarks,
			ar.NAME AS 'area.name',
			(SELECT COUNT(1) FROM sys_office AS B WHERE B.parent_id = A.id AND B.del_flag = 0) AS 'num'
		FROM
			sys_office a
		LEFT JOIN sys_area ar ON ar.id = a.area_id
		<!-- 数据范围过滤 -->
		${sqlMap.dsf}
		AND a.del_flag = 0
		ORDER BY a.code
	</select>
	<!-- 用于修改上级机构 -->
	<select id="findByParentIdsLike" resultType="Office">
		SELECT
			a.id,
			a.parent_id AS 'parent.id',
			a.parent_ids,
			a.CODE,
			a.NAME,
			a.type,
			a.grade,
			a.remarks,
			ar.NAME AS 'area.name',
			(SELECT COUNT(1) FROM sys_office AS B WHERE B.parent_id = A.id AND B.del_flag = 0) AS 'num'
		FROM
			sys_office a
		LEFT JOIN sys_area ar ON ar.id = a.area_id
		WHERE 1 = 1
			<if test="parentIds != null and parentIds != '%%'">
				AND a.parent_ids LIKE #{parentIds}
				<if test="id != null and id != ''">
					 or a.id=#{id } 
				</if>
			</if>
		AND a.del_flag = 0
		ORDER BY a.code
	</select>
	
	<!-- 根据父类id查询子类数据 用于异步加载树形table -->
	<select id="findByPidforChild" resultType="Office">
		SELECT
			a.id,
			a.parent_id AS 'parent.id',
			a.code,
			a.grade,
			a.name,
			"直营店" AS 'typeName',
			a.remarks,
			ar.name AS 'area.name'
		FROM
			sys_office a
		LEFT JOIN sys_area ar ON ar.id = a.area_id
		WHERE a.del_flag = #{DEL_FLAG_NORMAL} 
			AND a.parent_id = #{id } 
		ORDER BY a.code
	</select>
	
	
	<!-- 添加加盟商时  同时添加到sys_office机构表中 -->
	<insert id="franchiseeSaveOffice">
		INSERT INTO sys_office(
			id, 
			parent_id, 
			parent_ids, 
			area_id, 
			code, 
			name, 
			sort, 
			type, 
			grade, 
			address, 
			zip_code, 
			master, 
			phone, 
			fax, 
			email, 
			create_by, 
			create_date, 
			update_by, 
			update_date, 
			remarks, 
			del_flag,
			useable,
			primary_person,
			deputy_person
		) VALUES (
			#{id}, 
			#{parent.id}, 
			#{parentIds}, 
			#{area.id}, 
			#{code}, 
			#{name}, 
			#{sort}, 
			#{type}, 
			#{grade}, 
			#{address}, 
			#{zipCode}, 
			#{master}, 
			#{phone}, 
			#{fax}, 
			#{email}, 
			#{createBy.id}, 
			#{createDate}, 
			#{updateBy.id}, 
			#{updateDate}, 
			#{remarks}, 
			#{delFlag},
			#{useable},
			#{primaryPerson.id},
			#{deputyPerson.id}
		)	 
	</insert>
	<update id="franchiseeUpdateOffice">
		UPDATE sys_office SET 
			name = #{name},
			area_id = #{area.id}, 
			type = #{type}, 
			update_by = #{updateBy.id}, 
			update_date = #{updateDate}
		WHERE id = #{id}
	</update>
	<insert id="insert">
		INSERT INTO sys_office(
			id, 
			parent_id, 
			parent_ids, 
			area_id, 
			
			district,
			city,
			province,
			
			code, 
			name, 
			sort, 
			type, 
			grade, 
			address, 
			zip_code, 
			master, 
			phone, 
			fax, 
			email, 
			create_by, 
			create_date, 
			update_by, 
			update_date, 
			remarks, 
			del_flag,
			useable,
			primary_person,
			deputy_person
		) VALUES (
			#{id}, 
			#{parent.id}, 
			#{parentIds},
			#{area.id},
			
			(SELECT id FROM sys_area WHERE CODE = (SELECT CODE FROM sys_area AS a WHERE a.`id` = #{area.id}) AND TYPE = 4 AND del_flag = 0),
			(SELECT id FROM sys_area WHERE CODE = LEFT((SELECT CODE FROM sys_area AS a WHERE a.`id` = #{area.id}),9) AND TYPE = 3 AND del_flag = 0),	
  			(SELECT id FROM sys_area WHERE CODE = LEFT((SELECT CODE FROM sys_area AS a WHERE a.`id` = #{area.id}),5) AND TYPE = 2 AND del_flag = 0),
			 
			#{code}, 
			#{name}, 
			#{sort}, 
			#{type}, 
			#{grade}, 
			#{address}, 
			#{zipCode}, 
			#{master}, 
			#{phone}, 
			#{fax}, 
			#{email}, 
			#{createBy.id}, 
			#{createDate}, 
			#{updateBy.id}, 
			#{updateDate}, 
			#{remarks}, 
			#{delFlag},
			#{useable},
			#{primaryPerson.id},
			#{deputyPerson.id}
		)
	</insert>
	
	<update id="update">
		UPDATE sys_office SET 
			parent_id = #{parent.id}, 
			parent_ids = #{parentIds}, 
			area_id = #{area.id}, 
			
			district = (SELECT id FROM sys_area WHERE CODE = (SELECT CODE FROM sys_area AS a WHERE a.`id` = #{area.id}) AND TYPE = 4 AND del_flag = 0),
			city = (SELECT id FROM sys_area WHERE CODE = LEFT((SELECT CODE FROM sys_area AS a WHERE a.`id` = #{area.id}),9) AND TYPE = 3 AND del_flag = 0),	
			province = (SELECT id FROM sys_area WHERE CODE = LEFT((SELECT CODE FROM sys_area AS a WHERE a.`id` = #{area.id}),5) AND TYPE = 2 AND del_flag = 0),
			
			code = #{code}, 
			name = #{name}, 
			type = #{type}, 
			grade = #{grade}, 
			address = #{address}, 
			zip_code = #{zipCode}, 
			master = #{master}, 
			phone = #{phone}, 
			fax = #{fax}, 
			email = #{email}, 
			update_by = #{updateBy.id}, 
			update_date = #{updateDate}, 
			remarks = #{remarks},
			useable=#{useable},
			primary_person=#{primaryPerson.id},
			deputy_person=#{deputyPerson.id}
		WHERE id = #{id}
	</update>
	
	<update id="updateParentIds">
		UPDATE sys_office SET 
			parent_id = #{parent.id}, 
			parent_ids = #{parentIds}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		DELETE FROM sys_office 
		WHERE id = #{id} OR parent_ids LIKE 
					<if test="dbName == 'oracle'">'%,'||#{id}||',%'</if>
					<if test="dbName == 'mysql'">CONCAT('%,', #{id}, ',%')</if>
	</update>
	
	<update id="deleteByLogic">
		UPDATE sys_office SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id} OR parent_ids LIKE 
					<if test="dbName == 'oracle'">'%,'||#{id}||',%'</if>
					<if test="dbName == 'mysql'">CONCAT('%,', #{id}, ',%')</if>
	</update>
	<!-- 保存店铺详细信息 存在时则更新 -->
	<insert id="saveOfficeInfo" parameterType="Office">
		insert into sys_office_info(
				id,
				short_name,
				postal_code,
				contacts,
				telephone,
				store_phone,
				begin_time,
				end_time,
				detailed_address,
				img,
				bed_num,
				status,
				del_flag
			) values (
				#{id},
				#{officeInfo.shortName},
				#{officeInfo.postalCode},
				#{officeInfo.contacts},
				#{officeInfo.telephone},
				#{officeInfo.storePhone},
				#{officeInfo.beginTime},
				#{officeInfo.endTime},
				#{officeInfo.detailedAddress},
				#{officeInfo.img},
				#{officeInfo.bedNum},
				#{officeInfo.status},
				#{DEL_FLAG_NORMAL}
			)ON DUPLICATE KEY 
				UPDATE 
				short_name		 = #{officeInfo.shortName},
				postal_code      = #{officeInfo.postalCode},
				contacts         = #{officeInfo.contacts},
				telephone        = #{officeInfo.telephone},
				store_phone      = #{officeInfo.storePhone},
				begin_time       = #{officeInfo.beginTime},
				end_time         = #{officeInfo.endTime},
				detailed_address = #{officeInfo.detailedAddress},
				img				 = #{officeInfo.img},
				bed_num			 = #{officeInfo.bedNum},
				status           = #{officeInfo.status},
				<if test="grade == 1">
					del_flag         = #{DEL_FLAG_NORMAL}
				</if>
				<if test="grade == 2">
					del_flag         = #{DEL_FLAG_DELETE}
				</if>
	</insert>
	
	<select id="findFNameByCode" resultType="OfficeInfo">
		SELECT
			id  AS franchiseeId,
			name  AS franchiseeName
		FROM sys_office
		WHERE 
			1=1
			AND del_flag = #{DEL_FLAG_NORMAL} 
			AND code = #{franchiseeCode}
	</select>
	<select id="findbyid" resultType="OfficeInfo">
		SELECT
			short_name   AS shortName,
			postal_code  AS postalCode,
			contacts     AS contacts,
			telephone    AS telephone,
			store_phone  AS storePhone,
			begin_time   AS beginTime,
			end_time     AS endTime,
			detailed_address AS detailedAddress,
			img,
			bed_num 	AS bedNum
		FROM sys_office_info
		WHERE 
			1=1
			AND del_flag = #{DEL_FLAG_NORMAL} 
			AND id = #{id}
	</select>
	<!-- 根据officeid查询店铺信息 -->
	<select id="OfficeInfoByid" resultType="OfficeInfo">
		SELECT
			short_name   AS shortName,
			postal_code  AS postalCode,
			contacts     AS contacts,
			telephone    AS telephone,
			store_phone  AS storePhone,
			begin_time   AS beginTime,
			end_time     AS endTime,
			detailed_address AS detailedAddress,
			img,
			bed_num 	 AS bedNum
		FROM sys_office_info
		WHERE del_flag =0 AND id = #{id}
	</select>
	<update id="deleteOfficeInfo">
		UPDATE sys_office_info SET 
			del_flag = #{DEL_FLAG_DELETE}
	    WHERE 
	    1=1
	    AND id = #{id}
	</update>
	<select id="exportOffice" resultType="OfficeInfo">
		SELECT
			(SELECT code FROM trains.sys_office WHERE id = o.parent_id) AS upOfficeCode,
			(SELECT NAME FROM trains.sys_office WHERE id = o.parent_id) AS upOfficeName,
			(SELECT code FROM trains.sys_office WHERE id = o.id) AS code,
			ar.code AS areaCode,
			ar.name AS areaName,
			o.name AS officeName,
			i.short_name AS shortName,
			i.postal_code  AS postalCode,
			i.contacts     AS contacts,
			i.telephone    AS telephone,
			i.store_phone  AS storePhone,
			i.begin_time   AS beginTime,
			i.end_time     AS endTime,
			i.bed_num	   AS bedNum,
			i.detailed_address AS detailedAddress
		FROM trains.sys_office AS o , trains.sys_office_info AS i,trains.sys_area AS ar 
		WHERE 
			1=1
			AND ar.id = o.area_id
			AND o.del_flag = #{DEL_FLAG_NORMAL} 
			AND o.grade = 1
			AND i.del_flag = #{DEL_FLAG_NORMAL} 
			AND i.id = o.id
			<if test="id != null and id != ''">
			AND o.parent_ids LIKE
				<if test="dbName == 'oracle'">'%,'||#{id}||',%'</if>
				<if test="dbName == 'mysql'">CONCAT('%,', #{id}, ',%')</if>
			</if>
	</select>
	<select id="verifyOfficeName" resultType="OfficeInfo">
		SELECT  id AS upOfficeId,
				NAME AS upOfficeName 
			FROM trains.`sys_office` 
			WHERE 
				code = #{upOfficeCode} 
				<if test="grade != 0">
					AND grade = #{grade}
				</if>
				AND del_flag = 0
	</select>
	<select id="verifyAreaName" resultType="OfficeInfo">
		SELECT id AS areaId,
			   NAME AS areaName,
			   (SELECT  COUNT(*) FROM trains.`sys_area` WHERE parent_id = (SELECT id FROM trains.`sys_area` WHERE CODE = #{areaCode}) )AS num
			FROM trains.`sys_area` 
			WHERE code = #{areaCode} AND del_flag = 0
	</select>
	<!-- 通过父类id验证机构名称是否存在 -->
	<select id="verifyOfficeNameByPid" resultType="Office">
		SELECT * FROM sys_office WHERE parent_id = #{id} AND name = #{name} and del_flag = 0
	</select>
	<!-- 导入机构 通过父code验证机构名称是否重复 -->
	<select id="verifyOfficeNameByCode" resultType="OfficeInfo">
		SELECT NAME AS officeName FROM trains.`sys_office` WHERE parent_id = (SELECT id FROM trains.sys_office WHERE CODE = #{upOfficeCode}) and del_flag = 0
	</select>
	<!-- 导入机构  保存机构 -->
	<insert id="saveOfficeInfo2" parameterType="OfficeInfo">
		insert into sys_office_info(
				id,
				short_name,
				postal_code,
				contacts,
				telephone,
				store_phone,
				begin_time,
				end_time,
				detailed_address,
				bed_num,
				del_flag
			) values (
				#{id},
				#{shortName},
				#{postalCode},
				#{contacts},
				#{telephone},
				#{storePhone},
				#{beginTime},
				#{endTime},
				#{detailedAddress},
				#{bedNum},
				#{DEL_FLAG_NORMAL}
			)
	</insert>
	<!-- 替换code前先在code前拼接特定的字符 -->
	<update id="updateCodeFirst">
		UPDATE sys_office SET code = CONCAT('coffee',code) WHERE code LIKE CONCAT(#{oldCode}, '%')
	</update>
	<!-- 替换code -->
	<update id="updateCodeLast">
		UPDATE sys_office SET  code = REPLACE(code,#{oldCode},#{newCode})
	</update>
	
	<!-- 根据选择的市场查找其对应的店铺 -->
	<select id="selectOfficeById" resultType="Office">
		SELECT id,name
		FROM sys_office
		WHERE parent_id = #{id}
		AND del_flag = 0
	</select>
	
	<!-- 根据美容师id查找其归属店铺或者市场 -->
	<select id="selectForSpec" resultType="Office">
		SELECT 
			o.id,
			o.parent_id AS "parent.id",
			o.grade
		FROM sys_office o
		LEFT JOIN sys_user u ON u.office_id = o.id
		WHERE u.id = #{id} 
	</select>
</mapper>