<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.training.modules.train.dao.TrainLiveAuditDao">
	<sql id="sqlColumns">
		a.id,
		a.userId,
		b.`name` as "userName",
		b.user_type,
		c.label as "remarks",
		a.title,
		a.name,
		a.desc,
		a.bengtime,
		a.endtime,
		a.templatetype,
		a.authtype,
		a.publisherpass,
		a.playpass,
		a.checkurl,
		a.barrage,
		a.foreignpublish,
		a.openlowdelaymode,
		a.showusercount,
		a.audit_status,
		a.create_date,
		a.audit_user,
		a.isPay,
		a.imgurl,
		a.live_remarks,
		r.roomId as "roomId",
		a.del_flag

	</sql>

	<!-- 根据编号获特长 -->
	<select id="get" resultType="TrainLiveAudit">
		SELECT
		<include refid="sqlColumns" />
		FROM trains.train_live_audit a 
		LEFT JOIN trains.sys_user b ON a.userId=b.id
		LEFT JOIN trains.sys_dict c ON c.`value`=b.user_type
		LEFT JOIN trains.train_live_room r ON r.userId=a.userId
		WHERE a.del_flag=0 AND c.type='sys_user_type'and a.id=#{id}

	</select>


	<!-- 分页查询 -->
	<select id="findList" resultType="TrainLiveAudit">
		SELECT
		<include refid="sqlColumns" />
		FROM trains.train_live_audit a 
		LEFT JOIN trains.sys_user b ON a.userId=b.id
		LEFT JOIN trains.sys_dict c ON c.`value`=b.user_type
		LEFT JOIN trains.train_live_room r ON r.userId=a.userId
		WHERE a.del_flag=0 AND c.type='sys_user_type'
		<if test="userName!=null and userName!=''">
			AND b.name like
			<if test="dbName == 'oracle'">'%'||#{userName}||'%'</if>
			<if test="dbName == 'mysql'">CONCAT('%',#{userName}, '%')</if>
		</if>
		<if test="title!=null and title!=''">
			AND a.title like
			<if test="dbName == 'oracle'">'%'||#{title}||'%'</if>
			<if test="dbName == 'mysql'">CONCAT('%',#{title}, '%')</if>
		</if>
		<if test="auditStatus!=null and auditStatus!=''">
			AND a.audit_status=#{auditStatus}
		</if>

		ORDER BY a.create_date DESC

	</select>
	<!-- 更新数据 -->
	<update id="update">
		UPDATE train_live_audit 
		SET
			audit_status=#{auditStatus},
			isPay=#{isPay},
			live_remarks=#{liveRemarks},
			audit_user=#{auditUser}
		WHERE id=#{id}
	</update>
	<!-- 审核直播 -->
	<update id="updateLiveOut">
		UPDATE 
			train_live_audit 
		SET 
			audit_status = 0,
			live_remarks = '审核未通过',
			audit_user = '超管'
		WHERE id=#{id}
	</update>
	<!-- 查询过期数据 -->
	<select id="selectOutLive" resultType="TrainLiveAudit">
		SELECT
			<include refid="sqlColumns" />
		FROM trains.train_live_audit a 
		LEFT JOIN trains.sys_user b ON a.userId=b.id
		LEFT JOIN trains.sys_dict c ON c.`value`=b.user_type
		LEFT JOIN trains.train_live_room r ON r.userId=a.userId
		WHERE a.del_flag=0 AND c.type='sys_user_type' AND a.audit_status = 1 AND a.bengTime <![CDATA[ <= ]]> SYSDATE()
	</select>
	<!-- 查询要直播数据 -->
	<select id="selectWantLive" resultType="TrainLiveAudit">
		SELECT
			<include refid="sqlColumns" />
		FROM trains.train_live_audit a 
		LEFT JOIN trains.sys_user b ON a.userId=b.id
		LEFT JOIN trains.sys_dict c ON c.`value`=b.user_type
		LEFT JOIN trains.train_live_room r ON r.userId=a.userId
		WHERE a.del_flag=0 AND c.type='sys_user_type' AND a.audit_status = 2 <![CDATA[  AND SYSDATE() < a.bengtime  AND a.bengtime <= date_add(SYSDATE(),INTERVAL 5 MINUTE)]]>
	</select>
	
	<!-- 分页查询直播Sku配置 -->
	<select id="findSkuList" resultType="TrainLiveSku">
		SELECT 
			id AS 'trainLiveSkuId',
			audit_id AS 'auditId',
			user_id AS 'userId',
			price,
			num,
			type,
			create_date AS 'createDate',
			update_by AS 'updateBy',
			update_create AS 'updateCreate'
		FROM trains.train_live_spec
		WHERE audit_id = #{auditId}
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
		</choose>
	</select>
	
	<!-- 分页查询直播订单列表 -->
	<select id="findOrderList" resultType="TrainLiveOrder">
		SELECT 
			lo.order_id AS 'trainLiveOrderId',
			lo.audit_id AS 'auditId',
			lo.user_id AS 'userId',
			u.name AS 'userName',
			lo.spec_id AS 'specid',
			lo.spec_price AS 'specprice',
			lo.spec_num AS 'specNum',
			lo.type,
			lo.pay_date AS 'payDate',
			lo.valid_date AS 'validDate',
			lo.order_status AS 'orderStatus',
			lo.create_date AS 'createDate',
			lo.del_flag AS 'delflag'
		FROM trains.train_live_order lo
		LEFT JOIN trains.sys_user u ON u.id = lo.user_id
		WHERE lo.del_flag = 0
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
		</choose>
	</select>
</mapper>