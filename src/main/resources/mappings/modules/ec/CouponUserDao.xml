<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.training.modules.ec.dao.CouponUserDao">
	<sql id="sqlColumns">
		a.user_id,
		a.coupon_id,
		a.amount_id,
		a.status,
		a.add_time,
		a.used_time,
		a.order_id,
		b.`nickname` as "name",
		c.order_amount as "orderAmount",
		d.coupon_name,
		d.coupon_type as "type",
		e.coupon_money as "couponMoney"
	</sql>
	<sql id="includetable">
		LEFT JOIN mtmydb.mtmy_users b ON a.user_id=b.user_id
		LEFT JOIN mtmydb.mtmy_orders c ON a.order_id=c.order_id
		LEFT JOIN mtmydb.mtmy_coupon d ON a.coupon_id=d.coupon_id
		LEFT JOIN mtmydb.mtmy_coupon_acmount_mapping e ON e.amount_id=a.amount_id
	</sql>
	<!-- 根据编号获特长 -->
	<select id="get" resultType="CouponUser">
		SELECT
		<include refid="sqlColumns" />

		FROM mtmydb.mtmy_coupon_user a
		<include refid="includetable"></include>

	</select>


	<!-- 分页查询 -->
	<select id="findList" resultType="CouponUser">
		SELECT
		<include refid="sqlColumns"></include>
		FROM mtmydb.mtmy_coupon_user a
		<include refid="includetable"></include>
		WHERE 1=1
		<if test="couponId != null  and couponId != ''">
			AND a.coupon_id=#{couponId}
		</if>
		<if test="name!=null and name!=''">
			AND b.nickname like
			<if test="dbName == 'oracle'">'%'||#{name}||'%'</if>
			<if test="dbName == 'mysql'">CONCAT('%',#{name}, '%')</if>
		</if>
		<if test="status!=null and status!=''">
			AND a.status=#{status}
		</if>
		<if test="begtime != null and begtime != ''">
			AND DATE_FORMAT(a.add_time,'%Y-%m-%d') >= DATE_FORMAT(#{begtime},'%Y-%m-%d')
		</if>
		<if test="endtime!=null and endtime!=''">
			<![CDATA[AND DATE_FORMAT(a.add_time,'%Y-%m-%d') <= DATE_FORMAT(#{endtime},'%Y-%m-%d')]]>
		</if>
		ORDER BY a.add_time DESC

	</select>
	<!-- 根据订单id查询 -->
	<select id="findByorderId"  resultType="CouponUser">
		SELECT
		a.user_id,
		a.coupon_id,
		a.amount_id,
		a.status,
		a.add_time,
		a.used_time,
		a.order_id
		FROM mtmydb.mtmy_coupon_user a
		WHERE a.order_id=#{orderId}
	
	
	</select>
	<!-- 改变红包状态 -->
	<update id="UpdateStatus">
		UPDATE mtmydb.mtmy_coupon_user SET
		status =#{status}
		WHERE order_id = #{orderId}
	</update>
    <!-- 推送内部红包 -->
	<insert id="insertSend">
		INSERT INTO mtmydb.mtmy_coupon_user (
			user_id,
			coupon_id,
			amount_id,
			status,
			add_time,
			used_time,
			order_id,
			order_price
		)SELECT
			mu.user_id,
			#{couponId},
			#{amountId},
			'0',
			SYSDATE(),
			NULL,
			NULL,
			NULL
		FROM
			mtmydb.mtmy_users mu
		WHERE
			mu.del_flag = 0
		AND user_id IN (
			SELECT
				su.mtmy_user_id
			FROM
				trains.sys_user su
		)

	</insert>
	<!-- 非内部红包推送 -->
	<insert id="insertFeiSend">
		INSERT INTO mtmydb.mtmy_coupon_user (
			user_id,
			coupon_id,
			amount_id,
			status,
			add_time,
			used_time,
			order_id,
			order_price
		)SELECT
			mu.user_id,
			#{couponId},
			#{amountId},
			'0',
			SYSDATE(),
			NULL,
			NULL,
			NULL
		FROM
			mtmydb.mtmy_users mu
		WHERE
		mu.del_flag=0 
		AND user_id NOT IN (
			SELECT
				su.mtmy_user_id
			FROM
				trains.sys_user su
		)
	</insert>
	
	<!-- 指定用户插入 -->
	<insert id="insertUserCoupon">
		INSERT INTO mtmydb.mtmy_coupon_user (
			user_id,
			coupon_id,
			amount_id,
			status,
			add_time,
			used_time,
			order_id,
			order_price
		)VALUES(
			#{userId},
			#{couponId},
			#{amountId},
			#{status},
			SYSDATE(),
			null,
			null,
			null
		)
			

	</insert>
	<!-- 根据面值金额查询 内部-->
	<select id="findByAmountidNum" resultType="Integer">
		SELECT
			count(*) AS num
		FROM
			mtmydb.mtmy_coupon_user
		WHERE
			amount_id in (#{amountId})
		AND user_id IN (
			SELECT
				mtmy_user_id
			FROM
				trains.sys_user
			WHERE
				mtmy_user_id IN (
					SELECT
						user_id
					FROM
						mtmydb.mtmy_users
				)
		)
	
	</select>
	
	<!-- 根据面值金额查询 非内部 -->
	<select id="findFeiByAmountidNum" resultType="Integer">
		SELECT
			count(*) AS num
		FROM
			mtmydb.mtmy_coupon_user
		WHERE
			amount_id IN (#{amountId})
		AND user_id IN (
			SELECT
				user_id
			FROM
				mtmydb.mtmy_users
			WHERE
				user_id NOT IN (
					SELECT
						mtmy_user_id
					FROM
						trains.sys_user
				)
		)
	
	</select>
	
	<!-- 根据Aid and userId -->
	<select id="findByAIdandUserId" resultType="Integer">
		SELECT
			count(*) as num
		FROM
			mtmydb.mtmy_coupon_user
		WHERE
			amount_id=#{amountId} and user_id=#{userId}
	</select>
	
</mapper>