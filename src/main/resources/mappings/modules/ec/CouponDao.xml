<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.training.modules.ec.dao.CouponDao">
	<sql id="sqlColumns">
		a.coupon_id,
		a.coupon_name,
		a.franchisee_id,
		c.`name` as "franchiseeName",
		a.coupon_type,
		b.usedNum as "usedNum",
		a.expiration_date,
		a.get_begintime,
		a.get_endtime,
		a.goods_use_type,
		a. STATUS,
		a.create_by AS "createBy.name",
		a.create_date,
		a.update_by AS "updateBy.name",
		a.update_date

	</sql>

	<!-- 根据编号获特长 -->
	<select id="get" resultType="Coupon">
		SELECT
		<include refid="sqlColumns" />
		FROM mtmydb.mtmy_coupon a
		LEFT JOIN trains.sys_franchisee c ON c.id=a.franchisee_id
		LEFT JOIN (
			SELECT
				coupon_id,
				COUNT(*) AS usedNum
			FROM
			mtmydb.mtmy_coupon_user
			GROUP BY
			coupon_id
		) b ON a.coupon_id = b.coupon_id
		WHERE
		a.coupon_id = #{couponId} and a.del_flag=0

	</select>


	<!-- 分页查询 -->
	<select id="findList" resultType="Coupon">
		SELECT
		<include refid="sqlColumns"></include>
		FROM
		mtmydb.mtmy_coupon a
		LEFT JOIN trains.sys_franchisee c ON c.id=a.franchisee_id
		LEFT JOIN (
			SELECT
				coupon_id,
				COUNT(*) AS usedNum
			FROM
			mtmydb.mtmy_coupon_user
			GROUP BY
			coupon_id
		) b ON a.coupon_id = b.coupon_id
		WHERE a.del_flag=0
		<!-- <if test="reType != null and reType != ''"> -->
		<!-- AND re_type=#{reType} -->
		<!-- </if> -->

		ORDER BY a.create_date DESC

	</select>
	<!-- 查询过期时间的数据 -->
	<select id="selectByTime" resultType="Coupon">
		SELECT
		<include refid="sqlColumns"></include>
		FROM
		mtmydb.mtmy_coupon a
		LEFT JOIN trains.sys_franchisee c ON c.id=a.franchisee_id
		LEFT JOIN (
			SELECT
				coupon_id,
				COUNT(*) AS usedNum
			FROM
			mtmydb.mtmy_coupon_user
			GROUP BY
			coupon_id
		) b ON a.coupon_id = b.coupon_id
		WHERE a.del_flag=0 and a.status in (0,1) 
	<![CDATA[	and a.expiration_date < SYSDATE()]]>
		ORDER BY a.create_date DESC
	</select>
	<!-- 保存数据 -->
	<insert id="insert" useGeneratedKeys="true" keyProperty="couponId">
		INSERT INTO mtmydb.mtmy_coupon (
		coupon_name,
		franchisee_id,
		coupon_type,
		expiration_date,
		get_begintime,
		get_endtime,
		goods_use_type,
		status,
		create_by,
		create_date

		)
		VALUES
		(
		#{couponName},
		#{franchiseeId},
		#{couponType},
		#{expirationDate},
		#{getBegintime},
		#{getEndtime},
		#{goodsUseType},
		#{status},
		#{createBy.name},
		SYSDATE()

		)

	</insert>
	<!-- 更新数据 -->
	<update id="update">
		UPDATE mtmydb.mtmy_coupon SET
		coupon_name=#{couponName},
		franchisee_id=#{franchiseeId},
		coupon_type=#{couponType},
		expiration_date=#{expirationDate},
		get_begintime=#{getBegintime},
		get_endtime=#{getEndtime},
		goods_use_type=#{goodsUseType},
		update_by=#{createBy.name},
		update_date=SYSDATE()
		where coupon_id=#{couponId}
	</update>
	<!-- 更新状态 -->
	<update id="updateStatus">
		UPDATE mtmydb.mtmy_coupon SET
		status=#{status},
		update_by=#{updateBy.name},
		update_date=SYSDATE()
		where coupon_id=#{couponId}
	</update>
	<!-- 修改开启时间 -->
	<update id="updateTime">
		UPDATE mtmydb.mtmy_coupon SET
		get_begintime=#{getBegintime},
		get_endtime=#{getEndtime},
		status=#{status},
		update_by=#{updateBy.name},
		update_date=SYSDATE()
		where coupon_id=#{couponId}
	</update>
	<!-- 过期更改状态 -->
	<update id="updateOldStatus">
		 UPDATE mtmydb.mtmy_coupon SET status=2 WHERE coupon_id=#{couponId}
	</update>
	
	<update id="updateSendStatus">
		UPDATE mtmydb.mtmy_coupon SET
			send_status=1
		where coupon_id=#{couponId}
	</update>

	<update id="updateTimeOStatus" parameterType="int">
		UPDATE mtmydb.mtmy_coupon SET
			status=2,
			update_date=SYSDATE()
		WHERE coupon_id=#{value}
	</update>
</mapper>