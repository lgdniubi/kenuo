<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.training.modules.ec.dao.ArticlesStatisticsDao">

	<!-- 获取定时器截止的 评论id -->
	<select id="findCommentId" resultType="int">
		SELECT
			id AS commentId
		FROM
			mtmydb.mtmy_articles_comment
		ORDER BY
			id DESC
		LIMIT 1
	</select>
	<!-- 获取定时器截止的 评论id -->
	<select id="findLikeId" resultType="int">
		SELECT
			id AS likeId
		FROM
			mtmydb.mtmy_articles_like
		ORDER BY
			id DESC
		LIMIT 1
	</select>

	<!-- 查询文章的id,评论数,点赞数 -->
	<select id="queryArticlesCountData" resultType="ArticlesStatisticsCountData" parameterType="java.util.Map">
		SELECT 
			t.articles_id AS articlesId,
			COUNT(1) AS commonCount,
			(SELECT COUNT(l.articles_id) AS likeCount FROM mtmydb.mtmy_articles_like AS l WHERE l.articles_id = t.articles_id AND id > #{mtmy_articles_like} ) AS likeCount,
			IFNULL((SELECT mas.articles_id FROM mtmydb.mtmy_articles_statistics mas WHERE mas.articles_id = t.articles_id),"NULL")AS 'isExist'
		FROM
			mtmydb.mtmy_articles_comment t
		WHERE 
			id > #{mtmy_articles_comment} AND del_flag = 0 
		GROUP BY
			t.articles_id
		ORDER BY t.articles_id
	</select>

	<!-- 修改mtmy_articles_statistics 表中文章的分享量 -->
	<update id="updateArticles" parameterType="ArticlesStatisticsCountData">
		UPDATE mtmydb.mtmy_articles_statistics
		<set>
			<if test="lookCount != null and lookCount != '' ">
				look_count = #{lookCount},
			</if>
			<if test="shareCount != null and shareCount != '' ">
				share_count = #{shareCount},
			</if>
			<if test="commonCount != null and commonCount != '' ">
				common_count = common_count + #{commonCount},
			</if>
			<if test="likeCount != null and likeCount != '' ">
				like_count = like_count + #{likeCount},
			</if>
			is_sham = 0
		</set>
		WHERE
		articles_id = #{articlesId}
	</update>

	<!-- 将文章的id,浏览量 插入mtmy_articles_statistics 表 -->
	<insert id="addArticles" parameterType="ArticlesStatisticsCountData">
		INSERT INTO mtmydb.mtmy_articles_statistics
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="articlesId != null">
				articles_id,
			</if>
			is_sham,
			<if test="lookCount != null">
				look_count,
			</if>
			<if test="shareCount != null">
				share_count,
			</if>
			<if test="commonCount != null">
				common_count,
			</if>
			<if test="likeCount != null">
				like_count,
			</if>
		</trim>
		<trim prefix="VALUES (" suffix=")" suffixOverrides=",">
			<if test="articlesId != null">
				#{articlesId},
			</if>
			0,
			<if test="lookCount != null">
				#{lookCount},
			</if>
			<if test="shareCount != null">
				#{shareCount},
			</if>
			<if test="commonCount != null">
				#{commonCount},
			</if>
			<if test="likeCount != null">
				#{likeCount},
			</if>
		</trim>
		ON DUPLICATE KEY UPDATE look_count = #{lookCount};
	</insert>
</mapper>