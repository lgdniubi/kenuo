<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.training.modules.ec.dao.ReservationDao">
	<sql id="ReservationColumns">
		r.reservation_id AS reservationId,
		r.beautician_id AS beauticianId,
		r.user_id AS userId,
		r.user_phoneNum AS userPhoneNum,
		r.user_name AS userName,
		r.reservation_dayTime AS reservationDayTime,
		r.beginTime AS beginTime,
		r.endTime AS endTime,
		r.shop_id AS shopId,
		r.reservation_status AS reservationStatus,
		r.createdTime,
		r.rec_id AS recId,
		r.remarks
	</sql>
	<select id="findAllList" resultType="Reservation">
		SELECT 
		  <include refid="ReservationColumns"/>,
		  m.goods_name AS 'goods.goodsName',
		  a.name AS 'user.name',
		  o.name AS 'office.name'
		FROM
		  mtmydb.mtmy_reservation AS r
		  LEFT JOIN trains.sys_office AS o ON r.shop_id = o.id
		  LEFT JOIN trains.sys_user AS a ON r.beautician_id = a.id
		  LEFT JOIN mtmydb.mtmy_order_goods_mapping AS m ON r.rec_id = m.rec_id
		WHERE 
			1=1
			<if test="beginDate != null and beginDate != '' and endDate != null and endDate != ''">
				AND r.reservation_dayTime BETWEEN #{beginDate} AND #{endDate}
			</if>
			<if test="reservationStatus != null and reservationStatus != ''">
				AND r.reservation_status = #{reservationStatus }
			</if>
			<if test="keyword != null and keyword != ''">
				AND ( r.user_name LIKE 
						<if test="dbName == 'oracle'">'%'||#{keyword}||'%'</if>
						<if test="dbName == 'mysql'">CONCAT('%', #{keyword}, '%')</if>
				OR r.user_phoneNum LIKE 
						<if test="dbName == 'oracle'">'%'||#{keyword}||'%'</if>
						<if test="dbName == 'mysql'">CONCAT('%', #{keyword}, '%')</if>
				OR o.name LIKE 
						<if test="dbName == 'oracle'">'%'||#{keyword}||'%'</if>
						<if test="dbName == 'mysql'">CONCAT('%', #{keyword}, '%')</if>
				OR a.name LIKE 
						<if test="dbName == 'oracle'">'%'||#{keyword}||'%'</if>
						<if test="dbName == 'mysql'">CONCAT('%', #{keyword}, '%')</if>
						)
			</if>
		ORDER BY r.reservation_dayTime DESC
	</select>
	<select id="findCountById" resultType="int">
		SELECT COUNT(*) FROM mtmydb.`mtmy_reservation` WHERE beautician_id = #{id} AND reservation_status = 0;
	</select>
	<select id="get" resultType="Reservation">
		SELECT 
		  <include refid="ReservationColumns"/>,
		  m.goods_name AS 'goods.goodsName',
		  a.name AS 'user.name',
		  o.name AS 'office.name',
		  o.id AS 'office.id'
		FROM
		  mtmydb.mtmy_reservation AS r
		  LEFT JOIN trains.sys_office AS o ON r.shop_id = o.id
		  LEFT JOIN trains.sys_user AS a ON r.beautician_id = a.id
		  LEFT JOIN mtmydb.mtmy_order_goods_mapping AS m ON r.rec_id = m.rec_id
		WHERE 
			1=1
			AND r.reservation_id = #{reservationId }
	</select>
	<update id="updateMnappointment">
		UPDATE mtmydb.mtmy_reservation SET 
			reservation_status  = #{reservationStatus},
			update_by = #{id},
			update_date = SYSDATE(),
			remarks = #{remarks}
			WHERE 
			1=1
			AND reservation_id = #{reservationId}
	</update>
	<!-- 查询所有美容师 -->
	<select id="loadBeauty" resultType="User">
		SELECT u.id,u.name 
			FROM 
				sys_user AS u 
			WHERE 
				u.office_id = #{office.id}
				AND u.user_type = 2
				AND u.del_flag = 0
	</select>
	<insert id="saveLog">
		INSERT INTO mtmydb.mtmy_reservation_log
			(
				reservation_id,
				beautician_id,
				shop_id,
				reservation_status,
				remarks,
				create_by,
				create_date
			)VALUES(
				#{reservationId},
				#{beauticianId},
				#{shopId},
				#{reservationStatus},
				#{remarks},
				#{createBy.id}, 
				SYSDATE()
			)
	</insert>
	<select id="findLog" resultType="ReservationLog">
		SELECT 
			l.id,
			l.reservation_id AS reservationId,
			l.beautician_id AS beauticianId,
			l.shop_id AS shopId,
			l.reservation_status AS reservationStatus,
			l.remarks,
			l.create_by AS "createBy.id",
			l.create_date,
			u1.name AS "createBy.name",
			u.name AS userName,
			o.name AS officeName
		FROM 
			mtmydb.mtmy_reservation_log AS l
			LEFT JOIN sys_user u1 ON l.create_by = u1.id
			LEFT JOIN sys_user u ON l.beautician_id = u.id
			LEFT JOIN sys_office o ON l.shop_id = o.id
		WHERE 
			1=1
			AND reservation_id = #{reservationId}  
			ORDER BY l.create_date DESC
			LIMIT 2
	</select>
	<select id="findListLog" resultType="ReservationLog">
		SELECT 
			l.id,
			l.reservation_id AS reservationId,
			l.beautician_id AS beauticianId,
			l.shop_id AS shopId,
			l.reservation_status AS reservationStatus,
			l.remarks,
			l.create_by AS "createBy.id",
			l.create_date,
			u1.name AS "createBy.name",
			u.name AS userName,
			o.name AS officeName
		FROM 
			mtmydb.mtmy_reservation_log AS l
			LEFT JOIN sys_user u1 ON l.create_by = u1.id
			LEFT JOIN sys_user u ON l.beautician_id = u.id
			LEFT JOIN sys_office o ON l.shop_id = o.id
		WHERE 
			1=1
			AND reservation_id = #{reservationId}  
			ORDER BY l.create_date DESC
	</select>
</mapper>