<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.training.modules.ec.dao.ReservationDao">
	<sql id="ReservationColumns">
		r.id AS reservationId,
		r.goods_mapping_id AS goodsMappingId,
		r.goods_id AS goodsId,
		r.beautician_id AS beauticianId,
		r.user_id AS userId,
		r.user_name AS userName,
		r.user_phone AS userPhone,
		r.appt_date AS apptDate,
		r.appt_start_time AS apptStartTime,
		r.appt_end_time AS apptEndTime,
		r.shop_id AS shopId,
		r.performance,
		r.appt_status AS apptStatus,
		r.create_date,
		r.remarks,
		r.channel_flag AS channelFlag
	</sql>
	<select id="findAllList" resultType="Reservation">
		SELECT 
		  <include refid="ReservationColumns"/>,
		  m.goods_name AS 'goods.goodsName',
		  a.name AS 'user.name',
		  o1.name AS 'office.name'
		FROM
		  mtmydb.mtmy_appt_order AS r
		  LEFT JOIN trains.sys_office AS o1 ON r.shop_id = o1.id
		  LEFT JOIN trains.sys_user AS a ON r.beautician_id = a.id
		  LEFT JOIN mtmydb.mtmy_order_goods_mapping AS m ON r.goods_mapping_id = m.rec_id
		  ${sqlMap.dsf}
			<if test="apptStatus != null and apptStatus != ''">
				AND r.appt_status = #{apptStatus }
			</if>
			<if test="beginDate != null and beginDate != '' and endDate != null and endDate != ''">
				AND r.appt_date BETWEEN #{beginDate} AND #{endDate}
			</if>
			<if test="keyword != null and keyword != ''">
				AND ( r.user_name LIKE 
						<if test="dbName == 'oracle'">'%'||#{keyword}||'%'</if>
						<if test="dbName == 'mysql'">CONCAT('%', #{keyword}, '%')</if>
				OR r.user_phone LIKE 
						<if test="dbName == 'oracle'">'%'||#{keyword}||'%'</if>
						<if test="dbName == 'mysql'">CONCAT('%', #{keyword}, '%')</if>
				OR o1.name LIKE 
						<if test="dbName == 'oracle'">'%'||#{keyword}||'%'</if>
						<if test="dbName == 'mysql'">CONCAT('%', #{keyword}, '%')</if>
				OR a.name LIKE 
						<if test="dbName == 'oracle'">'%'||#{keyword}||'%'</if>
						<if test="dbName == 'mysql'">CONCAT('%', #{keyword}, '%')</if>
						)
			</if>
		ORDER BY r.appt_date DESC,r.appt_start_time DESC
	</select>
	<!-- 删除用户时   验证用户是否有预约  有 不可删除用户 -->
	<select id="findCountById" resultType="int">
		SELECT COUNT(*) FROM mtmydb.mtmy_appt_order WHERE beautician_id = #{id} AND appt_status = 0
	</select>
	<select id="get" resultType="Reservation">
		SELECT 
		  <include refid="ReservationColumns"/>,
		  m.goods_name AS 'goods.goodsName',
		  a.name AS 'user.name',
		  o.name AS 'office.name',
		  o.id AS 'office.id'
		FROM
		  mtmydb.mtmy_appt_order AS r
		  LEFT JOIN trains.sys_office AS o ON r.shop_id = o.id
		  LEFT JOIN trains.sys_user AS a ON r.beautician_id = a.id
		  LEFT JOIN mtmydb.mtmy_order_goods_mapping AS m ON r.goods_mapping_id = m.rec_id
		WHERE 
			1=1
			AND r.id = #{reservationId }
	</select>
	<!-- 查询可用的店铺 -->
	<select id="loadOffice" resultType="Office">
		CALL mtmydb.find_goods_for_shop(#{goodsId},0,#{nationName},#{provinceId},#{cityId},#{districtId},0,10000)
	</select>
</mapper>