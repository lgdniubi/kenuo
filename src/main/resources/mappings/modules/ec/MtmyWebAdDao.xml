<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.training.modules.ec.dao.MtmyWebAdDao">
	
	<!-- 查询出所有的首页广告图 -->
	<select id="findList" resultType="MtmyWebAd">
		SELECT 
			id AS 'mtmyWebAdId',
			category_id AS 'categoryId',
			align,
			name,
			head_img AS 'headImg',
			suboriginal_img AS 'suboriginalImg',
			position_type AS 'positionType',
			data_type AS 'dataType',
			redirect_url AS 'redirectUrl',
			is_show AS 'isShow',
			remarks,
			create_date AS 'createDate',
			del_flag AS 'delFlag'
		FROM mtmydb.mtmy_web_ad
		WHERE category_id = #{categoryId}
		AND del_flag = '0'
	</select>
	
	<!-- 根据mtmyWebAdId获取相应的首页广告图 -->
	<select id="getMtmyWebAd" parameterType="int" resultType="MtmyWebAd">
		SELECT 
			id AS 'mtmyWebAdId',
			category_id AS 'categoryId',
			align,
			name,
			head_img AS 'headImg',
			suboriginal_img AS 'suboriginalImg',
			position_type AS 'positionType',
			data_type AS 'dataType',
			redirect_url AS 'redirectUrl',
			is_show AS 'isShow',
			remarks,
			create_date AS 'createDate',
			del_flag AS 'delFlag'
		FROM mtmydb.mtmy_web_ad
		WHERE del_flag = '0'
		AND id = #{mtmyWebAdId}
	</select>
	
	<!-- 更改首页广告图的状态 -->
	<update id="updateIsShow">
		UPDATE mtmydb.mtmy_web_ad
		SET is_show = #{isShow}
		WHERE id = #{mtmyWebAdId}
	</update>
	
	<!-- 插入首页广告图 -->
	<insert id="insertMtmyWebAd">
		INSERT INTO mtmydb.mtmy_web_ad(
			category_id,
			name,
			position_type,
			align,
			suboriginal_img,
			head_img,
			data_type,
			redirect_url,
			is_show,
			create_by,
			create_date,
			del_flag
		)values(
			#{categoryId},
			#{name},
			#{positionType},
			#{align},
			#{suboriginalImg},
			#{headImg},
			#{dataType},
			#{redirectUrl},
			'1',
			#{createBy.id},
			NOW(),
			'0'
		)
	</insert>
	
	<!-- 更新首页广告图 -->
	<update id="updateMtmyWebAd">
		UPDATE mtmydb.mtmy_web_ad
		SET 
			name = #{name},
			align = #{align},
			suboriginal_img = #{suboriginalImg},
			head_img = #{headImg},
			data_type = #{dataType},
			redirect_url = #{redirectUrl},
			update_by = #{updateBy.id},
			update_date = NOW()
		WHERE id = #{mtmyWebAdId}
	</update>
	
	<!-- 逻辑删除首页广告图 -->
	<update id="delMtmyWebAd">
		UPDATE mtmydb.mtmy_web_ad
		SET del_flag = '1'
		WHERE id = #{mtmyWebAdId}
	</update>
	
	<!-- 查询出首页广告图对应的商品 -->
	<select id="findGoodsList" resultType="Goods">
		SELECT
			mg.goods_id,
			mg.goods_name,
			mg.market_price,
			mg.original_img
		FROM mtmydb.mtmy_goods mg
		LEFT JOIN mtmydb.mtmy_web_ad_goods wag ON wag.goods_id = mg.goods_id
		WHERE wag.ad_id = #{adId}
	</select>
	
	<!-- 保存首页广告图对应的商品 -->
	<insert id="insertGoods">
		INSERT INTO mtmydb.mtmy_web_ad_goods(
			ad_id,
			goods_id
		)VALUES(
			#{adId},
			#{goodsId}
		)
	</insert>
	
	<!-- 删除首页广告图对应的商品 -->
	<delete id="delGoods">
		DELETE FROM mtmydb.mtmy_web_ad_goods
		WHERE ad_id = #{adId}
		AND	goods_id=#{goodsId}
	</delete>
	
	<!-- 添加商品前删除首页广告图对应的所有商品 -->
	<delete id="delAllGoods">
		DELETE FROM mtmydb.mtmy_web_ad_goods
		WHERE ad_id = #{adId}
	</delete>
	
	<!-- 根据categoryId逻辑删除首页广告图 ,当为非一级分类时-->
	<update id="delMtmyWebAdByCategoryIdForNotFirst">
		UPDATE mtmydb.mtmy_web_ad
		SET del_flag = '1'
		WHERE category_id = #{categoryId}
	</update>
	
	<!-- 根据categoryId逻辑删除首页广告图 ,当为一级分类时-->
	<update id="delMtmyWebAdByCategoryIdForFirst">
		UPDATE mtmydb.mtmy_web_ad
		SET del_flag = '1'
		WHERE category_id IN(SELECT id FROM mtmydb.mtmy_web_ad_category WHERE parent_ids LIKE CONCAT('%', #{categoryId}, '%') OR parent_id = #{categoryId})
	</update>
	
	<!-- 根据categoryId屋里删除首页广告图对应的所有商品,当为非一级分类时 -->
	<delete id="delAllGoodsByCategoryIdForNotFirst">
		DELETE FROM mtmydb.mtmy_web_ad_goods 
		WHERE ad_id IN(SELECT id FROM mtmydb.mtmy_web_ad WHERE category_id = #{categoryId})
	</delete>
	
	<!-- 根据categoryId屋里删除首页广告图对应的所有商品,当为一级分类时 -->
	<delete id="delAllGoodsByCategoryIdForFirst">
		DELETE FROM mtmydb.mtmy_web_ad_goods 
		WHERE ad_id IN(SELECT id FROM mtmydb.mtmy_web_ad WHERE category_id IN(SELECT id FROM mtmydb.mtmy_web_ad_category WHERE parent_ids LIKE CONCAT('%', #{categoryId}, '%') OR parent_id = #{categoryId}))
	</delete>
	
	<!-- 修改当前页面上所有组的状态 -->
	<update id="changAllIsShow">
		UPDATE mtmydb.mtmy_web_ad
		SET is_show = '1'
		WHERE category_id = #{categoryId}
		AND align = #{align}
	</update>
	
	<!-- 查询出最近创建的那一组的id -->
	<select id="selectIdByCreateDate" resultType="Integer">
		SELECT id AS mtmyWebAdId
		FROM mtmydb.mtmy_web_ad
		WHERE category_id = #{categoryId}
		AND align = #{align}
		ORDER BY create_date desc LIMIT 1
	</select>
</mapper>